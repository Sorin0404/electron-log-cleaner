name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "PR Title: $PR_TITLE"

        # Check if PR title follows conventional commits
        if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?:\ .+ ]]; then
          echo "::warning::PR title should follow conventional commits format"
          echo "::warning::Example: feat: add new feature"
          echo "::warning::Types: feat, fix, docs, style, refactor, test, chore, perf"
        fi

    - name: Check for TODO comments
      run: |
        if grep -r "TODO\|FIXME\|XXX" src/ --exclude-dir=node_modules; then
          echo "::warning::Found TODO/FIXME comments in source code"
        else
          echo "No TODO comments found"
        fi

    - name: Check file sizes
      run: |
        find src/ -type f -size +100k -exec ls -lh {} \; | awk '{print $9, $5}' || echo "All files are under 100KB"

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run coverage
      run: npm run test:coverage

    - name: Coverage Summary
      run: |
        echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat coverage/coverage-summary.json 2>/dev/null || echo "Coverage data not available"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Check for outdated dependencies
      run: npm outdated || true
